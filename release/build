#!/bin/bash

set -e

if [[ -z "$1" ]] && [[ -t 1 ]]; then
    echo "Usage:"
    echo -e "\t$0 /path/to/lattice.tgz [lattice release version]"
    echo -e "\t$0 [lattice release version] > /path/to/lattice.tgz"
    exit 1
fi

if [[ -t 1 ]]; then
  lattice_tgz=$1
  version_override=$2
else
  lattice_tgz="-"
  version_override=$1
fi

lattice_release_dir=$(cd `dirname $0` && cd .. && pwd)
diego_release_dir=$lattice_release_dir/diego-release
lattice_dir=$lattice_release_dir/src/github.com/cloudfoundry-incubator/lattice
receptor_dir=$lattice_release_dir/src/github.com/cloudfoundry-incubator/receptor

lattice_release_version=${version_override:-`git -C "$lattice_release_dir" describe --tags --always`}
lattice_version=$(git -C "$lattice_dir" describe --tags --always)
receptor_version=$(git -C "$receptor_dir" describe --tags --always)

tmp_dir=$(mktemp -d /tmp/lattice.XXXXXX)

cp -a $lattice_release_dir/release/root $tmp_dir/
cp $lattice_release_dir/release/src/install $tmp_dir/

lighttpd_dir=$tmp_dir/root/var/lattice/lighttpd
bin_dir=$tmp_dir/root/usr/local/bin
cell_helper_dir=$tmp_dir/root/var/vcap/jobs/file_server/packages/cell-helpers
versions_dir=$tmp_dir/root/var/lattice/versions
mkdir -p $lighttpd_dir $bin_dir $cell_helper_dir $versions_dir

export GOPATH=$lattice_release_dir:$diego_release_dir

pushd $lighttpd_dir >/dev/null
  ltc_src=github.com/cloudfoundry-incubator/lattice/ltc
  GOOS=linux GOARCH=amd64 go build -a -o linux/ltc "$ltc_src"
  GOOS=darwin GOARCH=amd64 go build -a -o osx/ltc "$ltc_src"
popd >/dev/null

export GOOS=linux
export GOARCH=amd64

pushd $bin_dir >/dev/null
  go build -a github.com/cloudfoundry-incubator/receptor/cmd/receptor
  go build -a github.com/cloudfoundry-incubator/lattice/cell-helpers/tee2metron
popd >/dev/null

pushd $cell_helper_dir >/dev/null
  go build -a github.com/cloudfoundry-incubator/lattice/cell-helpers/davtool
  go build -a github.com/cloudfoundry-incubator/lattice/cell-helpers/s3tool
  tar czf cell-helpers.tgz davtool s3tool
  rm -f davtool s3tool
popd >/dev/null

echo $lattice_release_version > $versions_dir/LATTICE_RELEASE
echo $lattice_version > $versions_dir/LATTICE
echo $receptor_version > $versions_dir/RECEPTOR

tar -czf "$lattice_tgz" -C "$tmp_dir" .

rm -rf "$tmp_dir"
