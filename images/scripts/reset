#!/bin/bash

set -e


exec 3>&1 4>&2 >>/var/pcfdev/reset.log 2>&1

source /var/pcfdev/common

if status runsvdir | grep -q 'start/running'; then
  wait_for_monit_to_start

  $monit stop all

  >&3 echo "Waiting for services to stop..."
  wait_for_services_to_stop

  stop runsvdir

  wait_for_monit_to_stop
fi

>&3 echo "Services stopped. Resetting data..."
rm -rf /var/vcap/{store/*,nfs} /var/vcap/data/{compile,tmp}

start runsvdir

wait_for_monit_to_start

$monit start postgres
while ! $monit summary | grep "'postgres'" | grep -q running; do
  sleep 1
done

psql -h 127.0.0.1 -p 5524 -U vcap -f /var/pcfdev/ccdb ccdb

$monit stop postgres

stop runsvdir

exec 1>&3 2>&4
